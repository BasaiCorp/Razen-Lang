#!/usr/bin/env bash

# Get the directory where this script is located
SCRIPT_DIR=$(dirname "$0")

# First try the development directory structure (script is in scripts/)
PROJECT_ROOT=$(cd "$SCRIPT_DIR/.." && pwd)
MAIN_PY="$PROJECT_ROOT/main.py"

# If main.py doesn't exist there, check installation directories
if [ ! -f "$MAIN_PY" ]; then
  # Check installation in /usr/local/lib/razen
  if [ -f "/usr/local/lib/razen/main.py" ]; then
    MAIN_PY="/usr/local/lib/razen/main.py"
  # Check installation in /usr/local/razen (macOS)
  elif [ -f "/usr/local/razen/main.py" ]; then
    MAIN_PY="/usr/local/razen/main.py"
  # Check Windows paths if running in WSL
  elif [ -f "/mnt/c/Program Files/Razen/main.py" ]; then
    MAIN_PY="/mnt/c/Program Files/Razen/main.py"
  fi
fi

# Check if main.py exists
if [ ! -f "$MAIN_PY" ]; then
  echo "Error: main.py not found at $MAIN_PY"
  echo "Please ensure Razen is properly installed."
  exit 1
fi

# Process arguments to get absolute path if it's a directory
if [ -n "$1" ] && [ -d "$1" ]; then
    # If a directory is provided, convert to absolute path
    if [[ "$1" == /* ]]; then
        # Directory already has an absolute path
        TEST_PATH="$1"
    else
        # Convert to absolute path
        TEST_PATH="$(cd "$1" 2>/dev/null && pwd)"
    fi
    shift
    python3 "$MAIN_PY" --mode=test "$TEST_PATH" "$@"
else
    # Run main.py in test mode with all arguments passed
    python3 "$MAIN_PY" --mode=test "$@"
fi

exit $?